<div class="chat-wrapper">
  <div class="chat-header">
    <div class="left-side">
      <button mat-icon-button class="back-button" (click)="navigateToList($event)">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <div class="user-info">
        <img [src]="getPartnerAvatar()" [alt]="(chat.theirUsername$ | async) || 'Contact'" class="avatar" />
        <div>
          <h3 class="username">
            {{ (chat.theirUsername$ | async) || 'Loading...' }}
          </h3>
        </div>
      </div>
    </div>

    <!-- Right side: status -->
    <div class="right-side">
      <div class="status">
        <span class="status-dot" [class.online]="isPartnerOnline" [class.offline]="!isPartnerOnline"></span>
        <span>{{
          isPartnerOnline
            ? ((chat.theirUsername$ | async) || 'Contact') + ' is online'
            : ((chat.theirUsername$ | async) || 'Contact') + ' is offline'
        }}</span>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <app-cache-info-banner [showBanner]="showCacheInfoBanner"></app-cache-info-banner>

    <!-- Public key status -->
    <!-- Loading state -->
    <div *ngIf="(chat.keyLoading$ | async) === true" class="key-loading">
      <mat-icon>security</mat-icon>
      <div *ngIf="chat.isGeneratingKeysAutomatically; else normalKeyLoading">
        Setting up encryption for first conversation...
      </div>
      <ng-template #normalKeyLoading>
        Loading {{ (chat.theirUsername$ | async) || 'contact' }}'s encryption key...
      </ng-template>
    </div>

    <!-- User's own private key is missing -->
    <div
      *ngIf="
        (chat.keyLoading$ | async) === false &&
        (chat.myPrivateKeyMissing$ | async) === true &&
        !chat.isGeneratingKeysAutomatically
      "
      class="key-recovery-overlay">
      <div class="key-recovery-card">
        <!-- Real key loss (user actually lost their keys) -->
        <div *ngIf="!chat.artificialKeyMissingState">
          <mat-icon>security</mat-icon>
          <div class="recovery-content">
            <h3>Your encryption keys are missing</h3>
            <p>
              Your private key could not be found. This might happen if you've cleared your browser data or switched
              devices.
            </p>
            <button mat-raised-button color="primary" (click)="regenerateEncryptionKeys()" class="recovery-button">
              Generate New Keys
            </button>
            <p class="warning-text">‚ö†Ô∏è Generating new keys will prevent you from reading previous messages.</p>
          </div>
        </div>

        <!-- Artificial key loss (partner lost their keys) -->
        <div *ngIf="chat.artificialKeyMissingState">
          <mat-icon>block</mat-icon>
          <div class="recovery-content">
            <h3>Chat Blocked - Partner Key Issue</h3>
            <p>
              <strong>{{ (chat.theirUsername$ | async) || 'Your contact' }}</strong> has lost their encryption keys and
              needs to regenerate them.
            </p>
            <p>
              You cannot send messages until they fix their encryption keys. This is a security measure to protect your
              communications.
            </p>
            <div class="partner-status">
              <mat-icon>info</mat-icon>
              <span>Waiting for {{ (chat.theirUsername$ | async) || 'your contact' }} to regenerate their keys...</span>
            </div>
            <p class="info-text">üí° Your keys are fine. This issue is on your partner's side.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Partner's public key is missing -->
    <div
      *ngIf="
        (chat.keyLoading$ | async) === false &&
        (chat.keyMissing$ | async) === true &&
        (chat.myPrivateKeyMissing$ | async) !== true
      "
      class="key-missing">
      <mat-icon>warning</mat-icon>
      <span
        >{{ (chat.theirUsername$ | async) || 'Your contact' }} hasn't set up encryption yet. You cannot send messages
        until they upload their public key.</span
      >
    </div>

    <!-- Partner key regeneration notification - BLOCKS CHAT -->
    <div *ngIf="chat.showPartnerKeyRegeneratedNotification$ | async" class="partner-key-regenerated-overlay">
      <div class="partner-key-regenerated-card">
        <mat-icon>block</mat-icon>
        <div class="notification-content">
          <h3>Chat Blocked</h3>
          <p>
            <strong>{{ (chat.theirUsername$ | async) || 'Your contact' }}</strong> is experiencing encryption key issues
            and may need to regenerate their keys.
          </p>
          <p>You must reload the page to continue chatting. Until you reload:</p>
          <ul>
            <li>You cannot send new messages</li>
            <li>New messages from your partner will appear encrypted</li>
            <li>The chat is completely blocked for your security</li>
          </ul>
          <div class="notification-buttons">
            <button
              mat-raised-button
              color="accent"
              (click)="checkPartnerKeyStatus()"
              class="check-button"
              [disabled]="(chat.keyLoading$ | async) === true">
              <mat-icon>sync</mat-icon>
              {{ (chat.keyLoading$ | async) ? 'Checking...' : 'Check Status' }}
            </button>
            <button mat-raised-button color="primary" (click)="reloadPage()" class="reload-button">
              <mat-icon>refresh</mat-icon>
              Reload Page
            </button>
          </div>
          <p class="security-note">This security measure ensures your messages remain encrypted.</p>
        </div>
      </div>
    </div>

    <!-- Chat window -->
    <div #messageContainer class="chat-window">
      <!-- Loading state for messages -->
      <div *ngIf="isLoadingMessages" class="messages-loading">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px">
          <mat-spinner diameter="40" color="primary"></mat-spinner>
          <p style="margin-top: 16px; color: #666">Loading messages...</p>
        </div>
      </div>

      <!-- Only show messages when loading is complete -->
      <ng-container *ngIf="!isLoadingMessages">
        <!-- Empty state -->
        <div *ngIf="!messageGroups.length" class="empty-chat">
          <mat-icon>chat</mat-icon>
          <p>No messages yet</p>
          <p>Start the conversation by sending a message</p>
        </div>

        <!-- Grouped messages with date headers -->
        <ng-container *ngFor="let group of messageGroups; trackBy: trackByDate">
          <!-- Date header -->
          <div class="date-header">
            <span class="date-text">{{ group.date }}</span>
          </div>

          <!-- Messages in this date group -->
          <div
            *ngFor="let m of group.messages; trackBy: trackByTs"
            class="message"
            [class.you]="m.sender === 'You'"
            [class.other]="m.sender !== 'You'"
            [class.deleted]="m.deletedAt"
            [class.unreadable]="isMessageUnreadable(m)"
            [class.encrypted]="isMessageEncrypted(m)">
            <div class="message-bubble">
              <div *ngIf="m.hasImage && m.imageUrl" class="message-image">
                <img
                  [src]="m.imageUrl"
                  [alt]="'Image attachment'"
                  class="attached-image"
                  (click)="openImageModal(m.imageUrl)"
                  (keydown.enter)="openImageModal(m.imageUrl)"
                  (keydown.space)="openImageModal(m.imageUrl)"
                  tabindex="0"
                  role="button"
                  [attr.aria-label]="'Open image in new tab'"
                  loading="lazy" />
              </div>

              <!-- Text content -->
              <p *ngIf="m.text" class="message-content">{{ getDisplayText(m.text, m.hasImage) }}</p>

              <div class="message-meta">
                <span class="message-time" [title]="getFullTimestamp(m.ts)">
                  {{ formatMessageTime(m.ts) }}
                </span>

                <span *ngIf="m.sender === 'You'" class="message-status">
                  <ng-container [ngSwitch]="m.status">
                    <mat-icon *ngSwitchCase="'pending'" class="status-icon">schedule</mat-icon>
                    <mat-icon *ngSwitchCase="'sent'" class="status-icon">check</mat-icon>
                    <mat-icon *ngSwitchCase="'read'" class="status-icon">done_all</mat-icon>
                  </ng-container>
                </span>

                <small *ngIf="!m.deletedAt && m.editedAt">&nbsp;(edited)</small>

                <!-- Show indicator for unreadable messages -->
                <small *ngIf="isMessageUnreadable(m)" class="unreadable-indicator"> &nbsp;(text unavailable) </small>
              </div>

              <!--  Action buttons only for editable messages -->
              <div *ngIf="canEditMessage(m)" class="message-actions">
                <button class="action-btn" (click)="beginEdit(m)" title="Edit" [disabled]="!canEditMessage(m)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button class="action-btn" (click)="delete(m)" title="Delete" [disabled]="!canEditMessage(m)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <!-- Show info for unreadable messages -->
              <div *ngIf="isMessageUnreadable(m)" class="message-actions unreadable-actions">
                <small class="unreadable-info">
                  <mat-icon class="info-icon">lock</mat-icon>
                  Cannot edit/delete
                </small>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>

    <!-- Typing indicator positioned between chat window and message form -->
    <div *ngIf="isPartnerTyping && !isLoadingMessages" class="typing-indicator">
      {{ (chat.theirUsername$ | async) || 'Contact' }} is typing
    </div>

    <!-- SIMPLE SCROLL TO BOTTOM BUTTON -->
    <button
      *ngIf="showScrollToBottomButton && !isLoadingMessages"
      class="scroll-to-bottom-btn"
      (click)="scrollToBottomClick()">
      <mat-icon>keyboard_arrow_down</mat-icon>
      <span *ngIf="newMessagesCount > 0" class="message-badge">
        {{ newMessagesCount > 99 ? '99+' : newMessagesCount }}
      </span>
    </button>

    <div *ngIf="attachedImage" class="attachment-preview">
      <div class="preview-content">
        <img [src]="attachedImage.preview" alt="Image preview" class="preview-image" />
        <div class="preview-info">
          <span class="preview-filename">{{ getTruncatedFilename(attachedImage.file.name) }}</span>
          <span class="preview-size">{{ (attachedImage.compressedSize / 1024).toFixed(1) }}KB</span>
        </div>
        <button type="button" class="remove-preview" (click)="removeAttachedImage()" title="Remove image">‚úï</button>
      </div>
    </div>

    <!-- Message form - keep inside container for desktop, fixed for mobile -->
    <form class="chat-form" (ngSubmit)="editing ? confirmEdit() : send()">
      <app-image-attachment [disabled]="isChatBlocked()" (imageSelected)="onImageSelected($event)">
      </app-image-attachment>

      <textarea
        *ngIf="!editing"
        class="message-input"
        [(ngModel)]="newMessage"
        name="message"
        [placeholder]="getChatInputPlaceholder()"
        required
        (input)="onType()"
        [rows]="1"
        #messageInput
        (keydown.enter)="onKeydownEnter($event)"
        (keydown.enter.control)="onKeydownCtrlEnter($event)"
        (keydown.enter.meta)="onKeydownMetaEnter($event)"
        [disabled]="isChatBlocked()"></textarea>

      <textarea
        *ngIf="editing"
        class="message-input"
        [(ngModel)]="editDraft"
        name="editDraft"
        placeholder="Edit message..."
        required
        [rows]="1"
        #editInput
        (keydown.enter)="onKeydownEnterEdit($event)"
        (keydown.enter.control)="onKeydownCtrlEnterEdit($event)"
        (keydown.enter.meta)="onKeydownMetaEnterEdit($event)"></textarea>

      <app-emoji-picker [disabled]="isChatBlocked()" (emojiSelected)="onEmojiSelected($event)"> </app-emoji-picker>

      <button
        type="submit"
        class="send-button"
        [disabled]="
          !(editing ? editDraft.trim() : newMessage.trim()) || (chat.connected$ | async) === false || isChatBlocked()
        "
        [attr.aria-label]="editing ? 'Save edited message' : 'Send message'">
        <svg
          width="24"
          height="24"
          viewBox="0 0 512 512"
          *ngIf="!editing"
          class="custom-send-icon"
          fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M181.297 312.455C175.176 306.681 153.359 287.953 153.117 280.127C152.774 269.004 166.832 263.147 171.886 254.841C173.458 252.258 174.437 249.027 175.648 246.249C208.443 171.04 263.53 113.253 340.822 82.9977C367.244 72.6547 403.596 61.7972 431.155 61C445.002 61.5453 448.825 71.3662 447.859 82.9661C443.749 132.342 425.376 184.652 398.606 225.94C369.151 271.371 326.027 306.454 277.602 330.361C268.729 334.742 266.934 334.729 259.953 341.817C254.528 347.325 244.121 360.736 236.495 361.15C226.925 361.67 210.738 341.351 202.751 334.187C182.838 355.363 160.894 376.704 140.07 396.959C134.366 402.508 128.898 409.735 122.056 413.821C112.353 418.176 100.714 411.112 100.579 400.44C100.442 389.73 113.365 381.29 120.446 373.961C140.483 353.22 161.049 332.99 181.297 312.455ZM327.486 138.179C270.066 143.974 277.934 223.897 333.163 222.399C391.098 216.228 380.881 134.624 327.486 138.179Z"
            fill="currentColor" />
          <path
            d="M80.4775 380.556C72.666 382.033 64.9421 377.127 63.3123 369.217C60.9645 357.821 72.3975 350.081 79.484 343.084C84.59 338.043 89.604 332.908 94.6512 327.806L106.604 315.66C111.145 311.012 114.378 306.728 121.015 305.337C135.161 304.402 143.339 319.171 133.575 329.896C126.376 337.8 118.044 345.403 110.511 353.112L94.9852 368.858C90.6832 373.204 86.589 378.854 80.4775 380.556Z"
            fill="currentColor" />
          <path
            d="M261.56 380.108L273.449 367.781C283.011 358.007 285.247 358.272 297.095 351.69C312.482 343.143 327.703 333.413 341.773 322.792C347.235 318.668 352.438 313.969 358.425 310.635C358.698 311.286 358.433 325.205 358.432 327.19C358.427 343.063 351.387 429.396 340.469 440.448C329.149 451.908 318.944 438.47 311.679 431.048L293.686 412.856C284.615 403.756 269.077 389.621 261.56 380.108Z"
            fill="currentColor" />
          <path
            d="M131.679 251.896L144.02 239.926C153.804 230.299 153.539 228.048 160.129 216.12C168.685 200.629 178.425 185.305 189.058 171.14C193.186 165.64 197.89 160.402 201.228 154.374C200.577 154.1 186.643 154.367 184.655 154.368C168.765 154.373 82.3367 161.461 71.2725 172.453C59.7998 183.849 73.2531 194.123 80.6828 201.437L98.8952 219.552C108.005 228.685 122.156 244.327 131.679 251.896Z"
            fill="currentColor" />
          <path
            d="M154.434 450.731C146.507 452.212 138.53 447.459 136.691 439.487C134.209 428.731 144.553 421.848 151.316 415.211L178.807 387.87C182.995 383.617 186.467 379.243 192.57 377.901C200.022 377.064 206.943 380.117 209.514 387.538C213.11 397.923 204.919 403.53 198.442 410.061L167.192 441.058C163.179 445.068 160.007 448.992 154.434 450.731Z"
            fill="currentColor" />
        </svg>

        <mat-icon *ngIf="editing" aria-hidden="true">check</mat-icon>
      </button>

      <button *ngIf="editing" type="button" class="cancel-button" (click)="cancelEdit()" aria-label="Cancel editing">
        <mat-icon aria-hidden="true">close</mat-icon>
      </button>
    </form>
  </div>
</div>
