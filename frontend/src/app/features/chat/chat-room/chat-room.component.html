<div class="chat-wrapper">
  <div class="chat-header">
    <div class="left-side">
      <button mat-icon-button class="back-button" (click)="navigateToList($event)">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <div class="user-info">
        <img [src]="getPartnerAvatar()" [alt]="(chat.theirUsername$ | async) || 'Contact'" class="avatar" />
        <div>
          <h3 class="username">
            {{ (chat.theirUsername$ | async) || 'Loading...' }}
          </h3>
        </div>
      </div>
    </div>

    <!-- Right side: status -->
    <div class="right-side">
      <div class="status">
        <span class="status-dot" [class.online]="isPartnerOnline" [class.offline]="!isPartnerOnline"></span>
        <span>{{
          isPartnerOnline
            ? ((chat.theirUsername$ | async) || 'Contact') + ' is online'
            : ((chat.theirUsername$ | async) || 'Contact') + ' is offline'
        }}</span>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <app-cache-info-banner [showBanner]="showCacheInfoBanner"></app-cache-info-banner>

    <!-- Public key status -->
    <!-- Loading state -->
    <div *ngIf="(chat.keyLoading$ | async) === true" class="key-loading">
      <mat-icon>security</mat-icon>
      <div *ngIf="chat.isGeneratingKeysAutomatically; else normalKeyLoading">
        Setting up encryption for first conversation...
      </div>
      <ng-template #normalKeyLoading>
        Loading {{ (chat.theirUsername$ | async) || 'contact' }}'s encryption key...
      </ng-template>
    </div>

    <!-- User's own private key is missing -->
    <div
      *ngIf="
        (chat.keyLoading$ | async) === false &&
        (chat.myPrivateKeyMissing$ | async) === true &&
        !chat.isGeneratingKeysAutomatically
      "
      class="key-recovery-overlay">
      <div class="key-recovery-card">
        <!-- Real key loss (user actually lost their keys) -->
        <div *ngIf="!chat.artificialKeyMissingState">
          <mat-icon>security</mat-icon>
          <div class="recovery-content">
            <h3>Your encryption keys are missing</h3>
            <p>
              Your private key could not be found. This might happen if you've cleared your browser data or switched
              devices.
            </p>
            <button mat-raised-button color="primary" (click)="regenerateEncryptionKeys()" class="recovery-button">
              Generate New Keys
            </button>
            <p class="warning-text">‚ö†Ô∏è Generating new keys will prevent you from reading previous messages.</p>
          </div>
        </div>

        <!-- Artificial key loss (partner lost their keys) -->
        <div *ngIf="chat.artificialKeyMissingState">
          <mat-icon>block</mat-icon>
          <div class="recovery-content">
            <h3>Chat Blocked - Partner Key Issue</h3>
            <p>
              <strong>{{ (chat.theirUsername$ | async) || 'Your contact' }}</strong> has lost their encryption keys and
              needs to regenerate them.
            </p>
            <p>
              You cannot send messages until they fix their encryption keys. This is a security measure to protect your
              communications.
            </p>
            <div class="partner-status">
              <mat-icon>info</mat-icon>
              <span>Waiting for {{ (chat.theirUsername$ | async) || 'your contact' }} to regenerate their keys...</span>
            </div>
            <p class="info-text">üí° Your keys are fine. This issue is on your partner's side.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Partner's public key is missing -->
    <div
      *ngIf="
        (chat.keyLoading$ | async) === false &&
        (chat.keyMissing$ | async) === true &&
        (chat.myPrivateKeyMissing$ | async) !== true
      "
      class="key-missing">
      <mat-icon>warning</mat-icon>
      <span
        >{{ (chat.theirUsername$ | async) || 'Your contact' }} hasn't set up encryption yet. You cannot send messages
        until they upload their public key.</span
      >
    </div>

    <!-- Partner key regeneration notification - BLOCKS CHAT -->
    <div *ngIf="chat.showPartnerKeyRegeneratedNotification$ | async" class="partner-key-regenerated-overlay">
      <div class="partner-key-regenerated-card">
        <mat-icon>block</mat-icon>
        <div class="notification-content">
          <h3>Chat Blocked</h3>
          <p>
            <strong>{{ (chat.theirUsername$ | async) || 'Your contact' }}</strong> is experiencing encryption key issues
            and may need to regenerate their keys.
          </p>
          <p>You must reload the page to continue chatting. Until you reload:</p>
          <ul>
            <li>You cannot send new messages</li>
            <li>New messages from your partner will appear encrypted</li>
            <li>The chat is completely blocked for your security</li>
          </ul>
          <div class="notification-buttons">
            <button
              mat-raised-button
              color="accent"
              (click)="checkPartnerKeyStatus()"
              class="check-button"
              [disabled]="(chat.keyLoading$ | async) === true">
              <mat-icon>sync</mat-icon>
              {{ (chat.keyLoading$ | async) ? 'Checking...' : 'Check Status' }}
            </button>
            <button mat-raised-button color="primary" (click)="reloadPage()" class="reload-button">
              <mat-icon>refresh</mat-icon>
              Reload Page
            </button>
          </div>
          <p class="security-note">This security measure ensures your messages remain encrypted.</p>
        </div>
      </div>
    </div>

    <!-- Chat window -->
    <div #messageContainer class="chat-window">
      <!-- Loading state for messages -->
      <div *ngIf="isLoadingMessages" class="messages-loading">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px">
          <mat-spinner diameter="40" color="primary"></mat-spinner>
          <p style="margin-top: 16px; color: #666">Loading messages...</p>
        </div>
      </div>

      <!-- Only show messages when loading is complete -->
      <ng-container *ngIf="!isLoadingMessages">
        <!-- Empty state -->
        <div *ngIf="!messageGroups.length" class="empty-chat">
          <mat-icon>chat</mat-icon>
          <p>No messages yet</p>
          <p>Start the conversation by sending a message</p>
        </div>

        <!-- Grouped messages with date headers -->
        <ng-container *ngFor="let group of messageGroups; trackBy: trackByDate">
          <!-- Date header -->
          <div class="date-header">
            <span class="date-text">{{ group.date }}</span>
          </div>

          <!-- Messages in this date group -->
          <div
            *ngFor="let m of group.messages; trackBy: trackByTs"
            class="message"
            [class.you]="m.sender === 'You'"
            [class.other]="m.sender !== 'You'"
            [class.deleted]="m.deletedAt"
            [class.unreadable]="isMessageUnreadable(m)"
            [class.encrypted]="isMessageEncrypted(m)">
            <div class="message-bubble">
              <!-- Image display - disabled for this iteration -->
              <!-- <div *ngIf="m.hasImage && m.imageUrl" class="message-image">
                <img 
                  [src]="m.imageUrl" 
                  [alt]="'Image attachment'"
                  class="attached-image"
                  (click)="openImageModal(m.imageUrl)"
                  (keydown.enter)="openImageModal(m.imageUrl)"
                  (keydown.space)="openImageModal(m.imageUrl)"
                  tabindex="0"
                  role="button"
                  [attr.aria-label]="'Open image in new tab'"
                  loading="lazy">
              </div> -->

              <!-- Text content -->
              <p class="message-content">{{ m.text }}</p>

              <div class="message-meta">
                <span class="message-time" [title]="getFullTimestamp(m.ts)">
                  {{ formatMessageTime(m.ts) }}
                </span>

                <span *ngIf="m.sender === 'You'" class="message-status">
                  <ng-container [ngSwitch]="m.status">
                    <mat-icon *ngSwitchCase="'pending'" class="status-icon">schedule</mat-icon>
                    <mat-icon *ngSwitchCase="'sent'" class="status-icon">check</mat-icon>
                    <mat-icon *ngSwitchCase="'read'" class="status-icon">done_all</mat-icon>
                  </ng-container>
                </span>

                <small *ngIf="!m.deletedAt && m.editedAt">&nbsp;(edited)</small>

                <!-- Show indicator for unreadable messages -->
                <small *ngIf="isMessageUnreadable(m)" class="unreadable-indicator"> &nbsp;(text unavailable) </small>
              </div>

              <!--  Action buttons only for editable messages -->
              <div *ngIf="canEditMessage(m)" class="message-actions">
                <button class="action-btn" (click)="beginEdit(m)" title="Edit" [disabled]="!canEditMessage(m)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button class="action-btn" (click)="delete(m)" title="Delete" [disabled]="!canEditMessage(m)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <!-- Show info for unreadable messages -->
              <div *ngIf="isMessageUnreadable(m)" class="message-actions unreadable-actions">
                <small class="unreadable-info">
                  <mat-icon class="info-icon">lock</mat-icon>
                  Cannot edit/delete
                </small>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>

    <!-- Typing indicator positioned between chat window and message form -->
    <div *ngIf="isPartnerTyping && !isLoadingMessages" class="typing-indicator">
      {{ (chat.theirUsername$ | async) || 'Contact' }} is typing
    </div>

    <!-- SIMPLE SCROLL TO BOTTOM BUTTON -->
    <button
      *ngIf="showScrollToBottomButton && !isLoadingMessages"
      class="scroll-to-bottom-btn"
      (click)="scrollToBottomClick()">
      <mat-icon>keyboard_arrow_down</mat-icon>
      <span *ngIf="newMessagesCount > 0" class="message-badge">
        {{ newMessagesCount > 99 ? '99+' : newMessagesCount }}
      </span>
    </button>

    <!-- Image attachment preview - disabled for this iteration -->
    <!-- <div *ngIf="attachedImage" class="attachment-preview">
      <div class="preview-content">
        <img [src]="attachedImage.preview" alt="Image preview" class="preview-image">
        <div class="preview-info">
          <span class="preview-filename">üì∑ {{ attachedImage.file.name }}</span>
          <span class="preview-size">{{ (attachedImage.compressedSize / 1024).toFixed(1) }}KB</span>
        </div>
        <button type="button" class="remove-preview" (click)="removeAttachedImage()" title="Remove image">
          ‚úï
        </button>
      </div>
    </div> -->

    <!-- Message form - keep inside container for desktop, fixed for mobile -->
    <form class="chat-form" (ngSubmit)="editing ? confirmEdit() : send()">
      <!-- Image attachment disabled for this iteration -->
      <!-- <app-image-attachment
        [disabled]="isChatBlocked()"
        (imageSelected)="onImageSelected($event)">
      </app-image-attachment> -->

      <textarea
        *ngIf="!editing"
        class="message-input"
        [(ngModel)]="newMessage"
        name="message"
        [placeholder]="getChatInputPlaceholder()"
        required
        (input)="onType()"
        [rows]="1"
        #messageInput
        (keydown.enter)="onKeydownEnter($event)"
        (keydown.enter.control)="onKeydownCtrlEnter($event)"
        (keydown.enter.meta)="onKeydownMetaEnter($event)"
        [disabled]="isChatBlocked()"></textarea>

      <textarea
        *ngIf="editing"
        class="message-input"
        [(ngModel)]="editDraft"
        name="editDraft"
        placeholder="Edit message..."
        required
        [rows]="1"
        #editInput
        (keydown.enter)="onKeydownEnterEdit($event)"
        (keydown.enter.control)="onKeydownCtrlEnterEdit($event)"
        (keydown.enter.meta)="onKeydownMetaEnterEdit($event)"></textarea>

      <app-emoji-picker
        [disabled]="isChatBlocked()"
        (emojiSelected)="onEmojiSelected($event)">
      </app-emoji-picker>

      <button
        type="submit"
        class="send-button"
        [disabled]="
          !(editing ? editDraft.trim() : newMessage.trim()) || (chat.connected$ | async) === false || isChatBlocked()
        "
        [attr.aria-label]="editing ? 'Save edited message' : 'Send message'">
        <svg
          *ngIf="!editing"
          width="20"
          height="20"
          viewBox="0 0 512 512"
          fill="currentColor"
          class="custom-send-icon"
          aria-hidden="true">
          <g clip-path="url(#clip0_232_1230)">
            <path
              d="M159.696 330.41C151.681 322.841 123.113 298.291 122.797 288.033C122.347 273.451 140.755 265.773 147.374 254.886C149.432 251.499 150.714 247.264 152.3 243.622C195.242 145.034 267.375 69.2821 368.582 29.6213C403.181 16.063 450.781 1.83022 486.868 0.785166C505 1.5 510.005 14.3739 508.74 29.5799C503.359 94.3054 479.301 162.876 444.247 217C405.678 276.553 349.21 322.543 285.801 353.882C274.182 359.626 271.832 359.609 262.691 368.9C255.587 376.12 241.96 393.7 231.975 394.243C219.443 394.925 198.248 368.289 187.789 358.898C161.714 386.657 132.98 414.632 105.713 441.184C98.2434 448.458 91.0838 457.932 82.1252 463.288C69.4189 468.997 54.1791 459.736 54.0014 445.747C53.8223 431.707 70.7442 420.643 80.0159 411.037C106.253 383.848 133.183 357.329 159.696 330.41ZM351.121 101.957C275.933 109.553 286.236 214.322 358.554 212.358C434.416 204.269 421.037 97.2963 351.121 101.957Z" />
            <path
              d="M27.6805 419.681C17.4519 421.618 7.33802 415.186 5.20379 404.818C2.12955 389.878 17.1002 379.733 26.3795 370.561C33.0655 363.952 39.631 357.221 46.2399 350.534L61.8915 334.611C67.8373 328.518 72.0712 322.903 80.7621 321.08C99.2849 319.854 109.993 339.214 97.2072 353.273C87.7818 363.635 76.8716 373.601 67.0073 383.705L46.6773 404.347C41.0441 410.043 35.683 417.45 27.6805 419.681Z" />
            <path
              d="M264.795 419.094L280.363 402.935C292.884 390.123 295.812 390.47 311.326 381.842C331.474 370.638 351.404 357.884 369.828 343.961C376.981 338.555 383.793 332.395 391.634 328.024C391.991 328.877 391.643 347.123 391.642 349.726C391.635 370.533 382.417 483.704 368.12 498.192C353.298 513.215 339.935 495.599 330.422 485.87L306.862 462.022C294.984 450.094 274.639 431.564 264.795 419.094Z" />
            <path
              d="M94.7251 251.024L110.884 235.333C123.696 222.714 123.349 219.763 131.978 204.127C143.182 183.82 155.936 163.733 169.859 145.164C175.264 137.955 181.424 131.089 185.795 123.187C184.942 122.827 166.696 123.177 164.093 123.179C143.286 123.186 30.1149 132.476 15.6272 146.885C0.604461 161.825 18.2207 175.292 27.9493 184.88L51.7971 208.626C63.7252 220.598 82.2549 241.103 94.7251 251.024Z" />
            <path
              d="M124.521 511.671C114.142 513.614 103.696 507.382 101.288 496.932C98.0386 482.833 111.583 473.81 120.439 465.109L156.436 429.269C161.919 423.694 166.466 417.961 174.457 416.201C184.215 415.104 193.278 419.106 196.645 428.834C201.354 442.447 190.628 449.798 182.147 458.359L141.227 498.992C135.972 504.248 131.818 509.392 124.521 511.671Z" />
          </g>
          <defs>
            <clipPath id="clip0_232_1230">
              <rect width="512" height="512" fill="white" />
            </clipPath>
          </defs>
        </svg>

        <mat-icon *ngIf="editing" aria-hidden="true">check</mat-icon>
      </button>

      <button *ngIf="editing" type="button" class="cancel-button" (click)="cancelEdit()" aria-label="Cancel editing">
        <mat-icon aria-hidden="true">close</mat-icon>
      </button>
    </form>

  </div>

</div>
