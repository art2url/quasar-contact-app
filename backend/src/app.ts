// â”€â”€â”€ Imports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import express from 'express';
import helmet from 'helmet';
import path from 'path';
import {httpCors} from './config/cors';

// â”€â”€â”€ Route Imports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import authRoutes from './routes/auth.routes';
import keyRoutes from './routes/keys.routes';
import messageRoutes from './routes/messages.routes';
import userRoutes from './routes/users.routes';
import roomsRoutes from './routes/rooms.routes';

// â”€â”€â”€ App Initialization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = express();

// â”€â”€â”€ CRITICAL: Set trust proxy IMMEDIATELY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.set('trust proxy', 1);
console.log('ðŸ”§ Trust proxy set to 1 immediately');

// Import rate limiter AFTER trust proxy is set
import {globalLimiter} from './config/ratelimits';

// â”€â”€â”€ Health-check route â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get('/health', (_req, res) =>
  res.status(200).json({
    status: 'ok',
    uptime: process.uptime(),
    date: new Date().toISOString(),
    trustProxy: app.get('trust proxy'),
  })
);

// â”€â”€â”€ Middleware: Security and Parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(httpCors);

app.use(
  helmet({
    contentSecurityPolicy: false,
  })
);
app.use(express.json());

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ rate-limiting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Rate limiter comes AFTER trust proxy is set
app.use(globalLimiter);

// â”€â”€â”€ API Routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use('/api/auth', authRoutes);
app.use('/api/keys', keyRoutes);
app.use('/api/messages', messageRoutes);
app.use('/api/users', userRoutes);
app.use('/api/rooms', roomsRoutes);

// â”€â”€â”€ Serve Static Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1. Landing Page static assets (from /public folder)
app.use('/assets', express.static(path.join(__dirname, '../../public/assets')));
app.use('/css', express.static(path.join(__dirname, '../../public/css')));
app.use('/js', express.static(path.join(__dirname, '../../public/js')));
app.use('/images', express.static(path.join(__dirname, '../../public/images')));

// 2. Angular App static assets (from /dist folder)
app.use(
  '/app/assets',
  express.static(path.join(__dirname, '../../dist/assets'))
);
app.use('/app', express.static(path.join(__dirname, '../../dist')));

// â”€â”€â”€ Route Handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Landing page route (exact match for root)
app.get('/', (_req, res) => {
  res.sendFile(path.join(__dirname, '../../public', 'index.html'));
});

// Angular App routes (SPA fallback for /app/*)
app.get('/app/*', (_req, res) => {
  res.sendFile(path.join(__dirname, '../../dist', 'index.html'));
});

// â”€â”€â”€ Error handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(
  (
    err: unknown,
    _req: express.Request,
    res: express.Response,
    _next: express.NextFunction
  ) => {
    console.error('[Unhandled Error]', err);
    res.status(500).json({message: 'Server error'});
  }
);

// â”€â”€â”€ 404 fallback  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use((_req, res) => {
  res.status(404).json({message: 'Not Found'});
});

// â”€â”€â”€ Export App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default app;
